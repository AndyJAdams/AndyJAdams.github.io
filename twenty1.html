<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Twenty1</title>
	<style type="text/css">
		body{ 
			margin: 0; 
		}
		canvas{
			border: 1px solid black;
            touch-action: none;
		}
	</style>
</head>
<body>
	<canvas id='canvas'></canvas>
	
	<script>
	var canvas = document.getElementById('canvas');
	function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	scaleCanvas();
	var ctx = canvas.getContext('2d');

	var colorArray = [
	'#3cb44b','#42d4f4','#e6194b','#911eb4','#ffe119',
	'#9a6324','#469990','#bfef45','#800000','#ffd8b1',
	'#4363d8','#f032e6','#fabebe','#aaffc3','#f58231',
	'#808000','#748BA7','#e6beff','#fffac8','#a9a9a9'
	];

	ctx.font = '25px Arial';
	function Position(x,y,r,c){
		this.x = x;
		this.y = y;
		this.r = r;
		this.c = c;
	}

	function Block(x,y,w,h,value,r,c){
		this.x = x;
		this.y = y;
		this.w = w;
		this.h = h;
		this.r = r;
		this.c = c;
		this.value = value;

		this.draw = function(){
			ctx.fillStyle = colorArray[this.value];
			ctx.fillRect(this.x, this.y, this.w, this.h);
			
		}

		this.update = function(){
			this.draw();
		}

		this.label = function(){
			ctx.fillStyle = '#000';
			ctx.fillText(this.value +'', this.x+(this.w/2)-12, this.y+(this.w/2)+5);
		}
	}	

	var blockScale = ((innerWidth*0.75)/6);
	var blockArray = [];
	var positions = [];
	var gridSize = (blockScale * 6);
	for(var x = 0; x < 6; x++){
		for(var y = 0; y < 6; y++){
			var xpos = (x*blockScale)+(innerWidth/2-gridSize/2);
			var ypos = (y*blockScale)+(innerHeight/2-gridSize/2);
			blockArray.push(new Block(xpos, ypos,blockScale,blockScale,Math.round(Math.random()*8),y,x));
			positions.push(new Position(xpos,ypos,x,y));
		}
	}
        
    var Debug = "Debug \n";

	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);
        
		for(var i = 0; i < blockArray.length; i++){
            if(blockArray[i] != undefined){
                blockArray[i].update();
            }
		}

		for(var i = 0; i < blockArray.length; i++){
            if(blockArray[i] != undefined){
                blockArray[i].label();
            }
		}
        
        ctx.fillText(Debug,10,30);
	}

	var closestBlock = -1;
    var mx = 0;
    var my = 0;
	function findClosestBlock(a,b){
		for(var i = 0; i < blockArray.length;i++){
			if(
                blockArray[i] != undefined && 
                a > blockArray[i].x && 
                a < blockArray[i].x+blockArray[i].w && 
                b > blockArray[i].y && 
                b < blockArray[i].y+blockArray[i].h
            ){
				return i;
			}
		}
        return -1;
	}

	window.addEventListener('touchstart', function(evt){
        evt.preventDefault();
		mx = evt.changedTouches[0].pageX;
        my = evt.changedTouches[0].pageY; 
        
        Debug = " TOUCH START ";
    }, false);
	
    window.addEventListener('touchmove', function(evt){
        evt.preventDefault();
    }, false);
	
    window.addEventListener('touchcancel', function(evt){
        evt.preventDefault();
        closestBlock = -1;
    }, false);
	
    window.addEventListener('touchend', function(evt){
        evt.preventDefault();
        var emx = evt.changedTouches[0].pageX;
        var emy = evt.changedTouches[0].pageY;
        closestBlock = findClosestBlock(mx,my);
        if(closestBlock > -1){
        	var cval = blockArray[closestBlock].value;
            if(Math.abs(emx-mx) > Math.abs(emy-my)){
                //Horizontal
                if(Math.abs(emx-mx) > blockScale/2){
                    if(emx-mx > 0){
                        //Right
                        var rblock = findClosestBlock(mx+blockScale,emy);
                        if(rblock > -1){
                            var rval = blockArray[rblock].value;
                            if(rval+cval < 22){
                                blockArray[rblock].value = rval+cval;
                                blockArray[closestBlock].w = 0;
                                Remove21();
                            }
                        }
                    } else if(emx-mx < 0){
                        //Left
                        var lblock = findClosestBlock(mx-blockScale,emy);
                        if(lblock > -1){
                        	var lval = blockArray[lblock].value;
                        	if(lval+cval < 22){
                        		blockArray[lblock].value = lval + cval;
                        		blockArray[closestBlock].w = 0;
                        		Remove21();
                        	} 
                        }
                    }
                }
            } else {
                if(Math.abs(emy-my) > blockScale/2){
                    if(emy-my > 0){
                        //Down
                        var dblock = findClosestBlock(emx,blockScale+my);
                        if(dblock > -1){
                        	var dval = blockArray[dblock].value;
                        	if(dval+cval < 22){
                        		blockArray[dblock].value = dval + cval;
                        		blockArray[closestBlock].w = 0;;
                        		Remove21();
                        	}
                        }
                    } else if(emy-my < 0){
                        //Up
                        var ublock = findClosestBlock(emx,my-blockScale);
                        if(ublock > -1){
                        	var uval = blockArray[ublock].value;
                        	if(uval+cval < 22){
                        		blockArray[ublock].value = uval+cval;
                        		blockArray[closestBlock].w = 0;
                        		Remove21();
                        	}
                        }
                    }
                }
            }
            
        }
        closestBlock = -1;
    }, false);

    function Remove21(){
    	for(var i = 0; i < blockArray.length; i++){
    		if(blockArray[i].value == 21){
    			console.log("TODO ADD SCORE HERE");
    			blockArray[i] = undefined;
    		}
    	}
    }

    function DropBlocks(){
    	Debug = "Missing: ";
    	for(var i = 0; i < blockArray.length; i++){
    		if(blockArray[i].w < 1){
    			//Get the blocks above this and move down
    			Debug += blockArray[i].r + "," + blockArray[i].c + " ";
    		}
    	}
    }

	animate();
	</script>
</body>
</html>