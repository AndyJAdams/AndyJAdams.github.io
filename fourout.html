<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<title>4OUT</title>
	<style>
	html, body{
		overflow: hidden;
		margin:0;
		touch-action: none;
	}

	canvas{
		background-color: #FFF;
	}
	
	</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
	<script>
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');

		const DEBUG = true;
		var gridX =	6;
		var gridY = 9;
		var colorArray = ['#F16745','#FFC65D','#7BC8A4','#4CC3D9','#93648D','#828282'];
		var tileScaleX = 0; var tileScaleY = 0;
		var tiles = [];
		var positions = [];

		function scaleCanvas(){
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
			tileScaleX = innerWidth/gridX;
			tileScaleY = innerHeight/gridY;
		}

		function Tile(x,y,w,h,color, row, column){
			this.x = x; this.y = y; this.w = w; this.h = h; this.col = color;
			this.row = row; this.column = column;
			this.draw = function(){
				ctx.fillStyle= colorArray[this.col];
				if(selected == this){
					ctx.fillRect(this.x+10,this.y+10,this.w-20,this.h-20);
				} else {
					ctx.fillRect(this.x, this.y, this.w+1, this.h+1);
				}

				if(DEBUG){
					ctx.fillStyle="#FFF";
					ctx.fillText(this.row + ","+ this.column, this.x+2,this.y+20);
				}
			}

			this.update = function(){
				this.draw();
			}

		}

		function tilesMoving(){
			for(var i = 0;i < tiles.length; i++){
				for(var j = 0;j< tiles[i].length;j++){
					if(tiles[i][j].moveX || tiles[i][j].moveY){
						return true;
					}
				}
			}
			return false;
		}

		function buildGrid(){
			tiles = [];
			for(var y = 0; y < gridY; y++){
				var row = [];
				for(var x =0; x < gridX; x++){
					var color = Math.floor(Math.random()*colorArray.length);
					row.push(new Tile(x*tileScaleX,y*tileScaleY,tileScaleX,tileScaleY,color, x, y));
				}
				tiles.push(row);
			}
		}


		function scaleGrid(){
			for(var i = 0;i < tiles.length; i++){
				for(var j = 0;j< tiles[i].length;j++){
					tiles[i][j].x = tiles[i][j].dx = i*tileScaleX;
					tiles[i][j].y = tiles[i][j].dy = j*tileScaleY;
					tiles[i][j].w = tileScaleX;
					tiles[i][j].h = tileScaleY;
				}
			}
		}

		function animate(){
			window.requestAnimationFrame(animate);
			ctx.clearRect(0,0,innerWidth,innerHeight);

			for(var i = 0; i < tiles.length; i++){
				for(var j = 0; j < tiles[i].length; j++){
					tiles[i][j].update();
				}
			}
		}

		

		var selected = undefined;
		function grabSelected(x,y){
			for(var i = 0;i < tiles.length; i++){
				for(var j = 0;j< tiles[i].length;j++){
					if(x < tiles[i][j].x+tileScaleX && x > tiles[i][j].x && y < tiles[i][j].y+tileScaleY && y > tiles[i][j].y){
						//tiles[i][j] is the tile we clicked on. let's now scan the rows/columns for pieces to impact
						selected = tiles[i][j];
						
					}
				}
			}
		}

		//Control variables
		var mx =-1,my=-1;
		var drag = false;
		var dir = 0;
		var cx = -1, cy = -1;

		function inputStart(evt){
			if(evt.changedTouches != undefined){
				var touches = evt.changedTouches;
				if(touches.length > 0 && touches.length < 2){
					mx = touches[0].pageX;
					my = touches[0].pageY;
				} else {
					DEBUG = !DEBUG;
				}
			} else {
				mx = evt.pageX;
				my = evt.pageY;
			}
			grabSelected(mx,my);
			drag = true;
		}

		function inputMove(evt){
			if(drag){
				if(evt.changedTouches != undefined){
					var touches = evt.changedTouches;
					if(touches.length > 0){
						cx = touches[0].pageX;
						cy = touches[0].pageY;
					}
				} else {
					cx = evt.pageX;
					cy = evt.pageY;
				}

					if(Math.abs(cx-mx) > tileScaleX/2 || Math.abs(cy-my) > tileScaleY/2){
						if(Math.abs(cx-mx) > Math.abs(cy-my)){ //Horizontal
							dir =-1;
							if(cx > mx){
								//RIGHT
							} else {
								//LEFT
							}

						} else { //Vertical
							dir = 1;
							if(cx > mx){
								//DOWN
							} else {
								//UP
							}
						}
					}
			}
		}

		function inputCancel(evt){
			inputEnd();
		}

		function inputEnd(){
			dir = 0;
			drag = false;
			selected = undefined;
		}

		window.addEventListener('touchstart', inputStart, false);
		window.addEventListener('touchmove',inputMove,false);
		window.addEventListener('touchcancel',inputCancel,false);
		window.addEventListener('touchend',inputEnd,false);

		window.addEventListener('mousedown',inputStart,false);
		window.addEventListener('mousemove',inputMove,false);
		window.addEventListener('mouseup',inputEnd,false);

		window.addEventListener('resize',function(){
			scaleCanvas();
			scaleGrid();
		});

		scaleCanvas();
		buildGrid();
		animate();
	</script>
	</body>
</html>