<DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Project XAROS</title>
<style>
body{
	margin: 0;
}
</style></head>
<body>
<canvas id='canvas'></canvas>
<script>
var canvas = document.querySelector('canvas');
function scaleCanvas(){
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
}
scaleCanvas();
var ctx = canvas.getContext('2d');

function Tower(x,y,width, color){
	this.x = x; this.y = y;
	this.width = width;
	this.color = color;
	this.draw = function(){
		ctx.fillStyle= this.color;
		ctx.fillRect(this.x-(this.width/2),this.y-(width/2),this.width, this.width);
	}

	this.update=function(){

		this.draw();
	}
}

function Menu(x,y){
	this.x = x;
	this.y = y;

	this.draw = function(){
		ctx.beginPath();
		ctx.moveTo(this.x-30, this.y-30);
		ctx.lineTo(this.x+30, this.y-30);
		ctx.lineTo(this.x+30, this.y+30);
		ctx.lineTo(this.x-30, this.y+30);
		ctx.lineTo(this.x-30, this.y-30);
		ctx.stroke();
		ctx.closePath();
	}

	this.update = function(){
		this.draw();
	}
}

var towers = [];
var menu = undefined;
towers.push(new Tower(innerWidth/2, innerHeight/2,10,'#0F0'));
var ongoingTouches = [];
var initialTouchId = undefined;
function animate(){
	window.requestAnimationFrame(animate);
	ctx.clearRect(0,0,innerWidth, innerHeight);

	for(var i = 0; i < towers.length; i++){
		towers[i].update();
	}
	if(menu != undefined){
		menu.update();
	}
}

function startup(){
	canvas.addEventListener('touchstart', handlestart, false);
	canvas.addEventListener('touchend', handleend, false);
	canvas.addEventListener('touchcancel', handlecancel, false);
	canvas.addEventListener('touchmove', handlemove, false);
	canvas.addEventListener('mousedown',handlemstart, false);
	canvas.addEventListener('mousemove',handlemmove, false);
	canvas.addEventListener('mouseup',handlemend, false);
	canvas.addEventListener('mouseleave',handlemleave, false);
	console.log('initialized');
}

function handlestart(evt){
	evt.preventDefault();
	console.log('touch start');
	var touches = evt.changedTouches;
	for(var i = 0; i < touches.length; i++){
		if(initialTouchId == undefined){
			initialTouchId = touches[0].identifier;
			menu = new Menu(touches[i].pageX, touches[i].pageY);
			ctx.fillText(initialTouchId,20,20);
		}
		ongoingTouches.push(copyTouch(touches[i]));
		//towers.push(new Tower(touches[i].pageX, touches[i].pageY,40,'#F00'));
	}
}

function handlemove(evt){
	evt.preventDefault();
	var touches = evt.changedTouches;
	for(var i = 0; i < touches.length; i++){
		var idx = ongoingTouchIndexById(touches[i].identifier);
		if(idx >= 0){
			ongoingTouches.splice(idx,1,copyTouch(touches[i]));
		}
	}
}

function handleend(evt){
	evt.preventDefault();
	var touches = evt.changedTouches;
	for(var i = 0; i < touches.length; i++){
		var idx = ongoingTouchIndexById(touches[i].identifier);
		if(idx >= 0){
			ongoingTouches.splice(idx, 1);
		}
		if(idx == initialTouchId){
			menu = undefined;
			initialTouchId = -1;
		}
	}
}

function handlecancel(evt){
	evt.preventDefault();
	var touches = evt.changedTouches;
	for(var i = 0; i < touches.length; i++){
		var idx = ongoingTouchIndexById(touches[i].identifier);
		ongoingTouches.splice(idx, 1);
		if(idx == initialTouchId){
			menu = undefined;
		}
	}
}

function copyTouch(touch){
	return {identifier: touch.identifier,pageX: touch.pageX, pageY: touch.pageY};
}

function ongoingTouchIndexById(idToFind) {
  for (var i = 0; i < ongoingTouches.length; i++) {
    var id = ongoingTouches[i].identifier;
    
    if (id == idToFind) {
      return i;
    }
  }
  return -1;    // not found
}

function handlemstart(e){
	menu = new Menu(e.pageX, e.pageY);
	ctx.fillText(menu,20,20);
}

function handlemmove(e){
	//Do nothing for now..
}

function handlemend(e){
	menu = null;
}

function handlemleave(e){
	menu = null;
}

startup();
animate();
</script>
</body>
</html>