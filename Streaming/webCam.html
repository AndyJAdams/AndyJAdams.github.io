<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Webcam</title>
	<style type="text/css">
		body{
            margin: 0;
            overflow: hidden;
        }
        canvas{
            background-color: #000;
        }
	</style>
    <script src='../Util/tmi.min.js'></script>
    <script src='../Util/chat.js'></script>
</head>
<body id='body'>
    <video playsinline autoplay style='display:none;'></video>
    <canvas></canvas>
	<script>
        
        'use strict';
        
	   const video = document.querySelector('video');
       const canvas = window.canvas = document.querySelector('canvas');
        canvas.width = 800;
        canvas.height = 600;
        var ctx = canvas.getContext('2d');
        var onBreak = false;
        var color = undefined;
        function animate(){
            window.requestAnimationFrame(animate);
            ctx.clearRect(0,0,canvas.width,canvas.height);
           
            
            //Watch for break from stream command
            for(var i = 0; i < messages.length; i++){
                if(!messages[i].shown){
                        //User tools
                        var msgData = messages[i].msg.split(" ");
                        if(msgData[0] == "!color"){
                            color = msgData[1];
                        }
                    
                        //Streamer only commands
                        if(messages[i].user == "AndyJamesAdams"){
                            if(messages[i].msg == "!brb"){
                                onBreak = true;
                            } else if(messages[i].msg == "!back"){
                                onBreak = false;
                            } else if(messages[i].msg == "!normal"){
                                color = undefined;
                                onBreak = false;
                            }

                        } 
                        messages[i].shown = true;
                }
            }
            
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            
            if(color != undefined){
                colorScale(color);
            }
            
            if(onBreak){
                ctx.fillStyle='#000000CC';
                        ctx.fillRect(0,0,canvas.width,canvas.height);
                        ctx.font = '98px sans-serif';
                        ctx.textAlign='center';
                        ctx.fillStyle='#FFF';
                        ctx.fillText("BRB",canvas.width/2,canvas.height/2);
            }
        }
        
        function greyScale(){
            var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            var pixels = imgData.data;
            for(var i = 0, n = pixels.length; i < n; i+=4){
                var gray = pixels[i] * .3 + pixels[i+1] * .59 + pixels[i+2] * .11;
                pixels[i] = gray;
                pixels[i+1]=gray;
                pixels[i+2] = gray;
            }
            ctx.putImageData(imgData,0,0);
        }
        
        function colorScale(hex){
            var rgb = hexToRgb(hex);
            if(hex == null){
                color = undefined;
                return;
            }
            var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
            var pixels = imgData.data;
            for(var i = 0, n = pixels.length; i < n; i+=4){
                 var gray = pixels[i] * .3 + pixels[i+1] * .59 + pixels[i+2] * .11;
//                pixels[i] = (cmyk[0] == 1) ? 1: gray; //Cyan
//                pixels[i+1]= (cmyk[1]== 1) ? 1 : gray; //Magenta
//                pixels[i+2] = (cmyk[2] == 1)? 1 : gray; //Yellow
                pixels[i] = gray*(rgb.r/255);
                pixels[i+1] = gray*(rgb.g/255);
                pixels[i+2] = gray*(rgb.b/255);
                
                //pixels[i+3] = cmyk[3]; //Black
            }
            ctx.putImageData(imgData,0,0);
        }
        
       function handleCamSuccess(stream){
        window.stream = stream;
        video.srcObject = stream;
       }
       const constraints = {
        audio: false,
        video: true
       };
       
       function handleCamError(error){
        console.log(error.message);
       }
           
        function hexToRgb(hex) {
          var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
          } : null;
        }
            
        function hexToCMYK (hex) {
             var computedC = 0;
             var computedM = 0;
             var computedY = 0;
             var computedK = 0;

             hex = (hex.charAt(0)=="#") ? hex.substring(1,7) : hex;

             if (hex.length != 6) {
              return []; 
             }
             if (/[0-9a-f]{6}/i.test(hex) != true) {
              return []; 
             }

             var r = parseInt(hex.substring(0,2),16); 
             var g = parseInt(hex.substring(2,4),16); 
             var b = parseInt(hex.substring(4,6),16); 

             // BLACK
             if (r==0 && g==0 && b==0) {
              computedK = 1;
              return [0,0,0,1];
             }

             computedC = 1 - (r/255);
             computedM = 1 - (g/255);
             computedY = 1 - (b/255);

             var minCMY = Math.min(computedC,Math.min(computedM,computedY));

             computedC = (computedC - minCMY) / (1 - minCMY) ;
             computedM = (computedM - minCMY) / (1 - minCMY) ;
             computedY = (computedY - minCMY) / (1 - minCMY) ;
             computedK = minCMY;

             return [computedC,computedM,computedY,computedK];
        }
    navigator.mediaDevices.getUserMedia(constraints).then(handleCamSuccess).catch(handleCamError);
        animate();
	</script>
</body>
</html>
