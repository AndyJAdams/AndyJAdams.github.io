<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>BitPath</title>
	<style type="text/css">
		body, html{ 
			margin: 0; 
			background-color: #222;
			position: fixed;
		}
		canvas{
            touch-action: none;
		}
	</style>
</head>
<body id='body'>
	<canvas id='canvas'></canvas>
	
	<script>
	var canvas = document.getElementById('canvas');	
	function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	scaleCanvas();
	var ctx = canvas.getContext('2d');

	function lerp (start, end, amt){
  		return (1-amt)*start+amt*end
	}

	function getRandomInt(max){
		return Math.floor(Math.random()*Math.floor(max));
	}

	//GLOBAL VARIABLES
	var rows, columns, spacing,vertOffset,horzOffset;
	var pointSize = 10;
	var Points = [];


	function BuildGrid(r,c){

		rows = r;
		columns = c;

		if(rows > columns){
			spacing = Math.round(innerHeight/(rows));
			columns = Math.floor(innerWidth/spacing);
		} else {
			spacing = (innerWidth)/columns+1;
			rows = Math.floor(innerHeight/spacing);
		}
		horzOffset = (innerWidth/2)/columns;
		vertOffset = (innerHeight/2)/rows;
		BuildPoints();
	}

	BuildGrid(5,4);

	

	function Point(x,y,con,row,col){
		this.x = x;
		this.y = y;
		this.links = con;
		this.row = row;
		this.col = col;
		this.fillColor = '#DDD';

		this.draw = function(){
			ctx.fillStyle = this.fillColor;
			ctx.fillRect(this.x-(pointSize/2),this.y-(pointSize/2),pointSize,pointSize);

			for(var i = 0; i < this.links.length; i++){
				ctx.strokeStyle = '#666';
				ctx.lineWidth = Math.floor(pointSize/4);
				if(this.links[i] != undefined){
					ctx.beginPath();
					switch(i){
						case 0:
							ctx.moveTo(this.x,this.y-(pointSize+2));
							ctx.lineTo(this.links[i].x,this.links[i].y+(pointSize+2));
							break;
						case 1:
							ctx.moveTo(this.x+(pointSize+2),this.y);
							ctx.lineTo(this.links[i].x-(pointSize+2),this.links[i].y);
							break;
						case 2:
							ctx.moveTo(this.x,this.y+(pointSize+2));
							ctx.lineTo(this.links[i].x,this.links[i].y-(pointSize+2));
							break;
						case 3:
							ctx.moveTo(this.x-(pointSize+2),this.y);
							ctx.lineTo(this.links[i].x+(pointSize+2),this.links[i].y);
							break;
						default:
							break;
					}
					ctx.stroke();
					ctx.closePath();
				}
			}
			ctx.font = '12pt sans-serif';
			//ctx.fillText(this.row + "," + this.col,this.x,this.y+30);
		}

		this.addlink = function(newLink, direction){
			if(this.links.length < 4){
				this.links[direction] = newLink;
			}
		}

		this.unlink = function(direction){
			this.links[direction] = null;
		}

		this.clearLinks = function(){
			for(var i = 0; i < this.links.length;i++){
				if(this.links[i] != null && this.links[i] != undefined){
					this.links[i] = null;
				}
			}
		}
	}

	
	function BuildPoints(){
		Points = [];
		for(var r = 0; r < rows; r++){
			var col = [];
			for(var c = 0; c < columns; c++){
				var links = [];
				var nx = (c*spacing)+horzOffset;
				var ny = (r*spacing)+vertOffset;
				col.push(new Point(nx,ny,links,r,c));
			}
			Points.push(col);
		}
	}

	

	function BuildPath(count){
		var path = rows + "," + columns + "-";
		//Select a starting point at random, row then column
		var randStartRow = getRandomInt(rows-1);
		var randStartCol = getRandomInt(columns-1);
		var currentPoint = Points[randStartRow][randStartCol];
		currentPoint.fillColor = '#0F6';
		path += randStartRow+"," + randStartCol+"-";
		//Determine the number of steps for the path
		var steps = count;
		for(var i = 0; i < steps; i++){
			var randDirection = getRandomInt(3);

			var nx, ny;
			switch(randDirection){
				case 0:
					if(currentPoint.row-1 > -1){
						nx = currentPoint.row-1;
						ny = currentPoint.col;
						currentPoint.addlink(Points[nx][ny],0);
						currentPoint = Points[nx][ny];
						path+= randDirection+".";
					} else {
						i--;
					}
					break;
				case 1:
					if(currentPoint.col+1 < columns){
						nx = currentPoint.row;
						ny = currentPoint.col+1;
						currentPoint.addlink(Points[nx][ny],1);
						currentPoint = Points[nx][ny];
						path+= randDirection+".";
					} else {
						i--;
					}
					break;
				case 2:
					if(currentPoint.row+1 < rows){
						nx = currentPoint.row+1;
						ny = currentPoint.col;
						currentPoint.addlink(Points[nx][ny],2);
						currentPoint = Points[nx][ny];
						path+= randDirection+".";
					} else {
						i--;
					}
					break;
				case 3:
					if(currentPoint.col-1 > -1){
						nx = currentPoint.row;
						ny = currentPoint.col-1;
						currentPoint.addlink(Points[nx][ny],3);
						currentPoint = Points[nx][ny];
						path+= randDirection+".";
					} else {
						i--;
					}
					break;
				default:
					i--;
					break;
			}

		}
		console.log(path);
	}

	function unlinkAll(){
		for(var a = 0; a < rows; a++){
			for(var b = 0; b < columns; b++){
				if(Points[a][b] != null){
					Points[a][b].clearLinks();
				}
			}
		}
	}

	var ticker = 0;

	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);

		for(var a = 0; a < rows; a++){
			for(var b = 0; b < columns; b++){
				if(Points[a][b] != null){
					Points[a][b].draw();
				}
			}
		}	
		ticker++;
		if(ticker > 300){
			unlinkAll();
			BuildGrid(Math.floor(Math.random()*18),1);
			BuildPath(Math.floor(Math.random()*15));
			ticker = 0;
		}
		ctx.fillText(ticker+"",20,20);
	}
	

	var mx = 0; //Touch || Mouse initial input position on x
    var my = 0; //Touch || Mouse initial input position on y

	window.addEventListener('touchstart', function(evt){
        evt.preventDefault();
		mx = evt.changedTouches[0].pageX;
        my = evt.changedTouches[0].pageY; 
    }, false);
	
    window.addEventListener('touchmove', function(evt){
        evt.preventDefault();
    }, false);
	
    window.addEventListener('touchcancel', function(evt){
        evt.preventDefault();
    }, false);
	
	//User has removed finger... let's figure out the desired action here. 
    window.addEventListener('touchend', function(evt){
        evt.preventDefault();
    }, false);

    window.addEventListener('mousedown', function(evt){
    	evt.preventDefault();
    },false);

    window.addEventListener('mousemove', function(evt){
    	evt.preventDefault();
    },false);

    window.addEventListener('mouseup', function(evt){
    	evt.preventDefault();
    },false);

    window.addEventListener('resize', function(evt){
    	scaleCanvas();
    },false);

    
	animate();
	</script>
</body>
</html>