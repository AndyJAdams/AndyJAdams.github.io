<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Crossroads</title>
	<style type="text/css">
		body{
            margin: 0;
            touch-action: none;
            position: fixed;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
        }
        canvas{
            touch-action: none;
            background-color: #DDD;
        }
	</style>
</head>
<body id='body'>
	<canvas id='canvas'></canvas>
    <script src='../Util/grid.js'></script>
	<script>
	var canvas = document.getElementById('canvas');
    var gridSize ={rows:8,columns:5};
    
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	var ctx = canvas.getContext('2d');

    var path = [];
    var spacing = 60;
    var grid = new Grid(gridSize.rows,gridSize.columns,spacing,spacing,innerWidth/2, innerHeight/2);
    //*************************************************
    //*************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);
        
        grid.draw(ctx);
        
        if(path.length > 0){
            ctx.fillRect(path[0].x-10,path[0].y-10,20,20);
            for(var i = 1; i < path.length; i++){
                ctx.beginPath();
                ctx.moveTo(path[i-1].x, path[i-1].y);
                ctx.lineTo(path[i].x, path[i].y);
                ctx.stroke();
                ctx.closePath();
            }
        }
	}
    //*************************************************
    //*************************************************

	//*** INPUT SECTION **//
    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });


    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);

    var start = {x:-1,y:-1};
    var current = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
        }
        current.x = start.x;
        current.y = start.y;
        
        path.push(grid.getClosestPos(start.x, start.y));
    }

    function inputMove(evt){
        evt.preventDefault();
        if(start.x > -1){
            if(evt.changedTouches != undefined){
                var touches = evt.changedTouches;
                if(touches.length > 0){
                    current.x = touches[0].pageX;
                    current.y = touches[0].pageY;
                }
            } else {
                current.x = evt.pageX;
                current.y = evt.pageY;
            }
            if(path.length > 0){
                var close = grid.getClosestPos(current.x, current.y);
                if(path.length > 1){
                    var penultimate = path[path.length-2];
                    if(close.x == penultimate.x && close.y == penultimate.y){
                        path.pop();
                        return;
                    }
                }
                for(var i = 0; i < path.length; i++){
                    if(close.x == path[i].x && close.y ==path[i].y){
                        return;
                    }
                }
                var last = path[path.length-1];
                var d = Math.abs(Math.sqrt(Math.pow(last.x-close.x,2)+Math.pow(last.y-close.y,2)));
                if(d < spacing*1.25 && (last.x == close.x || last.y == close.y)){
                    path.push(close);
                }
            }
            
        }
    }

    function inputEnd(){
        start.x = -1;
        path = [];
    }

    scaleCanvas();
	animate();
	</script>
</body>
</html>
