<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Project Dash</title>
	<style type="text/css">
		body{
            margin: 0;
            touch-action: none;
            position: fixed;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
        }
        canvas{
            touch-action: none;
            background-color: #7180AC;
        }
	</style>
</head>
<body id='body'>
	<canvas id='canvas'></canvas>
    <script src='../Util/grid.js'></script>
	<script>
	var canvas = document.getElementById('canvas');
    var gridSize ={rows:8,columns:5};
    var grid = undefined;
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	var ctx = canvas.getContext('2d');

    function Player(r,c){
        console.log("Player at " + r + "," + c);
        this.r = r; this.c = c;
        this.tr = this.r; this.tc = this.c;
        this.x = grid.pos[this.r][this.c].x;
        this.y = grid.pos[this.r][this.c].y;
        this.tx = this.x; this.ty = this.y;
        this.dir = -1;
        this.draw = function(){
            ctx.fillRect(this.x-16,this.y-16,32,32);
						ctx.fillText(this.dir, 10,10);
        }

        this.update = function(){
            if(this.x > this.tx){
                this.x-= (this.x-this.tx)/10;
            } else if(this.x < this.tx){
                this.x += (this.tx-this.x)/10;
            }
            if(this.y > this.ty){
                this.y-= (this.y-this.ty)/10;
            } else if(this.y < this.ty){
                this.y+= (this.ty-this.y)/10;
            }

            if(Math.abs(this.x-this.tx) < 2 && Math.abs(this.y-this.ty) < 2){
                this.dir = -1;
            }
            this.draw();
        }

        this.move = function(dir){
            if(this.dir > -1){
                return;
            }
            this.dir = dir;
            switch(this.dir){
                case 0: //UP - negative in the row
                    for(var i = this.r; i > -1; i--){
                        //Here we'd iterate and stop at the next wall
                    }
                    this.tr = 0;
                    this.ty = grid.pos[0][this.c].y;
                    break;
                case 1: //RIGHT - positive in the colum
                    for(var i = this.c; i < grid.columns; i++){
                        //Here we iterate and stop at the next wall
                    }
                    this.tc = grid.columns-1;
                    this.tx = grid.pos[this.r][grid.columns-1].x;
                    break;
                case 2: //DOWN - positive in the row
                    for(var i = this.r; i < grid.rows; i++){
                        //Here we iterate and stop at the next wall
                    }
                    this.tr = grid.rows-1;
                    this.ty = grid.pos[grid.rows-1][this.c].y;
                    break;
                case 3: //LEFT - negative in the column
                    for(var i = this.c; i > -1; i--){
                        //Here we'd iterate to the next wall
                    }
                    this.tc = 0;
                    this.tx = grid.pos[this.r][0].x;
                    break;
                default:
                    this.dir = -1;
                    break;
            }
        }
    }

		function DEBUG(){
			this.msg = [];
			this.draw = function(){
				for(var i = 0; i < this.msg.length; i++){
					ctx.fillStyle='#FFF';
					ctx.fillText(this.msg[i],10,20+(i*12));
				}
			}

			this.log = function(msg){
				this.msg.push(msg.toString());
			}
		}

    var player = undefined;
		var debug = new DEBUG();

    function buildGrid(){
        gridSize.rows = Math.floor(Math.random()*6)+6;
        gridSize.columns = Math.floor(Math.random()*4)+5;
        grid = new Grid(gridSize.rows, gridSize.columns,64,64,innerWidth/2,innerHeight/2);
        console.log(grid.rows+"x"+grid.columns);
        player = new Player(Math.floor(Math.random()*grid.rows),Math.floor(Math.random()*grid.columns));
    }
    //*************************************************
    //*************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);

        if(grid == undefined){
            buildGrid();
        } else {
            grid.draw(ctx,32);
            player.update();
        }

				debug.draw();
	}
    //*************************************************
    //*************************************************

	//*** INPUT SECTION **//
    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });


    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);

    var start = {x:-1,y:-1};
    var current = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
        }
        current.x = start.x;
        current.y = start.y;

    }

    function inputMove(evt){
        evt.preventDefault();
        if(start.x > -1){
            if(evt.changedTouches != undefined){
                var touches = evt.changedTouches;
                if(touches.length > 0){
                    current.x = touches[0].pageX;
                    current.y = touches[0].pageY;
                }
            } else {
                current.x = evt.pageX;
                current.y = evt.pageY;
            }
        }
    }

    function inputEnd(){
        var d = Math.hypot(Math.abs(start.x-current.x),Math.abs(start.y-current.y));
        if(d > 16){
            if(Math.abs(start.x-current.x) > Math.abs(start.y-current.y)){
                //Horizontal
                if(start.x < current.x){//right
                    player.move(1);
                } else { //left
                    player.move(3);
                }
            } else {
                //Vertical
                if(start.y < current.y){ //down
                    player.move(2);
                } else {
                    player.move(0);
                }
            }
        }
        start.x = -1;
        path = [];
    }



    scaleCanvas();
	animate();
	</script>
</body>
</html>
