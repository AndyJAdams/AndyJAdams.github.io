<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Skating_Game</title>
	<style type="text/css">
		body{
      margin: 0;
      touch-action: none;
      position: fixed;
      -webkit-touch-callout: none !important;
      -webkit-user-select: none !important;
    }
    canvas{
        touch-action: none;
        background-color: #cdcdcd;
    }
	</style>
</head>
<body id='body'>
<canvas></canvas>
	<script>
  var center = {x: -1,y:-1};
	var canvas = document.querySelector('canvas');
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
    center.x = innerWidth/2;
    center.y = innerHeight/2;
	}
	var ctx = canvas.getContext('2d');
  scaleCanvas();
  var popped = false;

  function Board(x,y,ang,height=0){
    this.top = '#444'; this.bottom = '#F20';
    this.x = x; this.y = y; this.ang = ang;
    this.scale = 30; this.orgScale = this.scale;
    this.height = height; this.rot = 0; this.targRot = 0;
    this.spinSpeed = 10;
    this.flipCount = 0;
    this.flipqty = 0; this.flipToggle = false;
    this.display = this.top;
    this.draw = function(){
      // this.rot++;
      // if(this.rot >= 360){
      //   this.rot = 0;
      // }
      if(this.flipCount > 0){
        if(this.flipqty > this.scale){
          if(this.display == this.top){
            this.display = this.bottom;
          } else {
            console.log('set top');
            this.flipCount--;
            this.display = this.top;
          }
          this.flipToggle = true;
        } else if(this.flipqty < 1){
          this.flipToggle = false;
        }
        if(!this.flipToggle){
          this.flipqty+=2.5;
        } else {
          this.flipqty-=2.5;
        }
      } else {
        if(this.flipqty > 0){ //finish last flip
          this.flipqty-=2.5;
        } else { //Prevent negatives
          this.flipqty = 0;
        }
      }

      //x=r∗sin(θ),y=r∗cos(θ)
      //ctx.fillRect(this.x-(this.scale/2),this.y-((this.scale*2.5)/2),this.scale,(this.scale*2.5));
      let topleft = {x: this.x+((this.scale-this.flipqty)*Math.sin(degToRad(200+this.rot))),y: this.y+((this.scale)*Math.cos(degToRad(200+this.rot)))};
      let topright = {x: this.x+((this.scale-this.flipqty)*Math.sin(degToRad(160+this.rot))),y: this.y+((this.scale)*Math.cos(degToRad(160+this.rot)))};
      let bottomright = {x: this.x+((this.scale-this.flipqty)*Math.sin(degToRad(20+this.rot))),y: this.y+((this.scale)*Math.cos(degToRad(20+this.rot)))};
      let bottomleft = {x: this.x+((this.scale-this.flipqty)*Math.sin(degToRad(340+this.rot))),y: this.y+((this.scale)*Math.cos(degToRad(340+this.rot)))};
      //ctx.fillText(topleft.x+","+topleft.y,20,20);
      ctx.beginPath();
      ctx.moveTo(topleft.x, topleft.y);
      ctx.lineTo(topright.x, topright.y);
      ctx.lineTo(bottomright.x, bottomright.y);
      ctx.lineTo(bottomleft.x, bottomleft.y);
      ctx.closePath();
      //ctx.stroke();
      ctx.fillStyle= this.display;
      ctx.fill();
      //
      // ctx.beginPath();
      // ctx.arc(topleft.x,topleft.y,10,0,2*Math.PI);
      // ctx.fill();
      // ctx.closePath();

      ctx.beginPath();
      ctx.arc(this.x, this.y, this.scale, 0, 2*Math.PI);
      ctx.stroke();
      ctx.closePath();

      ctx.fillText(this.targRot,20,20);
    }

    this.update = function(){
      if(this.scale > this.orgScale){
        this.scale -= 0.1; //SLOW MO
      } else {
        popped = false;
      }
      if(this.rot > this.targRot){
        this.rot -= this.spinSpeed;
      } else if(this.rot < this.targRot){
        this.rot += this.spinSpeed;
      }
      this.draw();
    }

    this.spin = function(deg){
      this.targRot += deg;
      // if(this.targRot >= 360){
      //   this.targRot -= 360;
      // } else if(this.targRot <= 0){
      //   this.targRot+= 360;
      // }
    }
  }

  function degToRad(deg){
    return deg*(Math.PI/180);
  }

  var hold = 0;
  var board = new Board(innerWidth/2,innerHeight/2,0);
    //*************************************************
    //*************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);

    if(start.x > -1 && !popped){
      if(hold < 30){
        hold+= 0.2;
      }
      ctx.beginPath();
      ctx.arc(current.x,current.y,30+hold,0,2*Math.PI);
      ctx.stroke();
    } else {
      if(hold > 1){
        //Spawn effect for pop here
        board.scale += hold*2;
        hold = 0;
      }
      popped = true;
    }

    board.update();
	}
    //*************************************************
    //*************************************************

	//*** INPUT SECTION **//
    window.addEventListener('keyup',function(e){
        console.log(e.key);
        switch(e.key){
          // case 'f':
          //   board.flipCount = 3;
          //   break;
          default:
            break;
        }
    });

    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });


    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);

    var start = {x:-1,y:-1};
		var current = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
        }
				current.x = start.x;
				current.y = start.y;
    }

    function inputMove(evt){
        evt.preventDefault();
        if(start.x > -1){
            if(evt.changedTouches != undefined){
                var touches = evt.changedTouches;
                if(touches.length > 0){
                    current.x = touches[0].pageX;
                    current.y = touches[0].pageY;
                }
            } else {
                current.x = evt.pageX;
                current.y = evt.pageY;
            }
        }
    }

    function inputEnd(){
      if(popped){
        if(current.x-start.x > 50){
          board.spin(180);
        } else if(current.x-start.x < -50){
          board.spin(-180);
        }
      }
        start.x = -1;
    }
	animate();
	</script>
</body>
</html>
