<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>SpriteTrial</title>
	<style type="text/css">
		body{
            margin: 0;
            touch-action: none;
            position: fixed;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            overflow: hidden;
        }
        canvas{
            touch-action: none;
            background-color: #DDD;
        }
	</style>
</head>
<body id='body'>
	<canvas id='canvas'></canvas>
    <img id='shipsprite' src='./Art/Ship_Black.png'>
	<script>
	var canvas = document.getElementById('canvas');	
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
        
    var touchDebug = 'V0.002';
	var ctx = canvas.getContext('2d');
    var burn = false;
    var ship = document.getElementById('shipsprite');
    
    var sx = 0; var sy=0; var sw = 32; var sh = 32;
        
    var direction = 0;
    var SpinOff = [[0,0],[32,32],[64,0],[96,32],[96,0],[64,32],[32,0],[0,32]];
        //Orgranized for left spin order
    var index = 0;
    var frame = 0; 
    var shipSpeed = 0.10;
    var dx = innerWidth/2-16;
    var dy = innerHeight/2-16;
    var force ={x:0,y:0};
    var bv = 15; //Bullet Velocity
        
    function Blob(x,y,w,h){
        this.x = x; this.y = y; this.w = w; this.h = h;
        this.hit = false;
        this.draw = function(){
            ctx.lineWidth=2;
            if(!this.hit){
                ctx.strokeRect(this.x, this.y, this.w, this.h);
            }
        }
        
        this.update = function(){
            this.draw();
        }
        
        this.boom = function(){
            console.log("BOOM");
            this.hit = true;
        }
    }
        
    var blobs = [];
    for(var i = 0; i < 1; i++){
        blobs.push(new Blob(Math.random()*innerWidth,Math.random()*innerHeight,50,50));
    }
        
    function Bullet(x,y,ex,ey){
        this.x = x; this.y = y; this.ex = ex; this.ey = ey;
        this.draw = function(){
            ctx.fillRect(this.x-5,this.y-5,10,10);
        }
        
        this.update = function(){
            if(this.x > this.ex){
                this.x-= bv;
            } else if(this.x < this.ex){
                this.x+=bv;
            }
            if(this.y > this.ey){
                this.y-=bv;
            } else if(this.y < this.ey){
                this.y+=bv;
            }
            
            if(getDistance(this.x,this.y,this.ex,this.ey)<10){
                this.destroy();
            }
            
            this.draw();
            
            for(var i = 0; i < blobs.length; i++){
                if(!blobs[i].hit){
                    var dist = getDistance(this.x+5,this.y+5,blobs[i].x+blobs[i].w, blobs[i].y+blobs[i].h);
                    if(dist < blobs[i].w/2+5){
                        blobs[i].boom();
                        this.destroy();
                    }
                }
            }
        }
        
        this.destroy = function(){
            bullets.splice(this,1);
        }
    }
        
    var bullets = [];
    var fireTime = 0;
    var fire = false;
    var shipDraw = true;
    //******************************************************************
    //******************************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);
        
        for(var i = 0; i < bullets.length; i++){
            if(bullets[i] != undefined){
                bullets[i].update();
                var dist = getDistance(bullets[i].x+5,bullets[i].y+5,dx+32,dy+32);
                if(dist < 32){
                    bullets[i].destroy();
                    shipDraw=false;
                }
            }
        }
        
        for(var i = 0; i < blobs.length; i++){
            blobs[i].update();
        }
        
        //Draw touch input.
        if(current.x > -1){
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(current.x,current.y);
            ctx.stroke();
            ctx.closePath();
            
            ctx.beginPath();
            ctx.arc(start.x, start.y, 50, 0, 2*Math.PI);
            ctx.stroke();
            ctx.fillStyle='#DDD';
            ctx.fill();
        }
        
        var y = SpinOff[index][1];
        if(burn){ y+=64};
        if(shipDraw){
            ctx.drawImage(ship,SpinOff[index][0],y,sw,sh,dx,dy,32*2,32*2);
        }
        
        
        if(direction < -0.1 && frame >= 16){
            index++;
            frame = 0;
            //direction += 0.1;
        } else if(direction > 0.1 && frame >= 16){
            index--;
            frame = 0;
            //direction -= 0.1;
        }
        
        if(index > SpinOff.length-1){
            index = 0;
        } else if(index < 0){
            index = SpinOff.length-1;
        }
        frame++;
        
        if(burn){
            switch(index){ //Which way are we facing
                case 0: //Straight up
                    force.y -= shipSpeed;  
                    break;
                case 1: //Up-left
                    force.x -= shipSpeed/2;
                    force.y -= shipSpeed/2;
                    break;
                case 2: //Left
                    force.x -= shipSpeed;
                    break;
                case 3: //Down-left
                    force.x -= shipSpeed/2;
                    force.y += shipSpeed/2;
                    break;
                case 4: //Down
                    force.y += shipSpeed;
                    break;
                case 5: //Down-Right
                    force.x += shipSpeed/2;
                    force.y += shipSpeed/2;
                    break;
                case 6: //Right
                    force.x += shipSpeed;
                    break;
                case 7: //Upper Right
                    force.x += shipSpeed/2;
                    force.y -= shipSpeed/2;
                    break;
                default:
                    break;
            }
        } 
        
        if(fire && Date.now() > fireTime){
            switch(index){ //Which way are we facing
                case 0: //Straight up
                    bullets.push(new Bullet(dx+32,dy,dx+32,dy-innerHeight*2));
                    break;
                case 1: //Up-left
                    bullets.push(new Bullet(dx+8,dy+8,dx-innerHeight*2,dy-innerHeight*2));
                    break;
                case 2: //Left
                    bullets.push(new Bullet(dx,dy+32,dx-innerHeight*2,dy+32));
                    break;
                case 3: //Down-left
                    bullets.push(new Bullet(dx+8,dy+56,dx-innerHeight*2,dy+innerHeight*2));
                    break;
                case 4: //Down
                    bullets.push(new Bullet(dx+32,dy+64,dx+32,dy+innerHeight*2));
                    break;
                case 5: //Down-Right
                    bullets.push(new Bullet(dx+56,dy+56,dx+innerHeight*2,dy+innerHeight*2));
                    break;
                case 6: //Right
                    bullets.push(new Bullet(dx+64,dy+32,dx+innerHeight*2,dy+32));
                    break;
                case 7: //Upper Right
                    bullets.push(new Bullet(dx+56,dy+8,dx+innerHeight*2,dy-innerHeight*2));
                    break;
                default:
                    break;
            }
            fireTime = Date.now()+60;
        } 
        
        dy += force.y;
        dx += force.x;
        
        ctx.font = '10px sans-serif';
        ctx.fillText(touchDebug, 10,15);
        
        //WRAPPING SUCKAS
        if(dx > innerWidth + 32){
            dx = -30+force.x;
        } else if(dx < -32){
            dx = innerWidth+force.x;
        }
        
        if(dy > innerHeight+32){
            dy = -30+force.y;
        } else if(dy < -32){
            dy = innerHeight+force.y;
        }
        
        if(force.x > 10){
            force.x = 10;
        } else if(force.x < -10){
            force.x = -10;
        }
        
        if(force.y > 10){
            force.y = 10;
        } else if(force.y < -10){
            force.y = -10;
        }
        
	}
        
    function getDistance(x1,y1,x2,y2){
        return Math.sqrt(Math.pow(Math.abs(x2-x1),2)+Math.pow(Math.abs(y2-y1),2));
    }
      
	//*** INPUT SECTION **//
    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });
    
    window.addEventListener('keydown',processKey,false);
    window.addEventListener('keyup',releaseKey,false);
        
    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);
        
    function releaseKey(evt){
        if(evt.key == 'ArrowUp'){
            burn = false;
        }
        if(evt.key == 'ArrowLeft' || evt.key == 'ArrowRight'){
            direction = 0;
        }
        if(evt.key=='ArrowDown'){
            fire = false;
        }
    }
        
    function processKey(evt){
        evt.preventDefault();
        if(evt.key == 'ArrowUp'){
            burn = true;
        }
        switch(evt.key){
            case 'ArrowDown':
                direction = 0;
                fire = true;
                break;
            case 'ArrowLeft':
                //Spin the ship left... by updating the sprite.
                direction = -1;
                break;
            case 'ArrowRight':
                direction = 1;
                break;
            default:
                //Fuck off
                break;
        }
    }
    
    var start = {x:-1,y:-1};
    var current = {x:-1,y:-1};
    var prev = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
            prev.x = start.x;
            prev.y = start.y;
        }
    }
    
    function inputMove(evt){
        evt.preventDefault();
        var x = -1; var y = -1;
        if(start.x > -1){
            if(evt.changedTouches != undefined){
                var touches = evt.changedTouches;
                if(touches.length > 0){
                    current.x = touches[0].pageX;
                    current.y = touches[0].pageY;
                }
                
                var difX = Math.abs(start.x-current.x);
                var difY = Math.abs(start.y-current.y);
                
                if(difX > 100){
                    if(current.x < start.x){
                        direction = -1;
                    } else if(current.x > start.x){
                        direction = 1;
                    } 
                } else {
                    direction = 0;
                }
                
                if(difY > 100){
                    if(current.y < start.y){
                        burn = true;
                    }
                } else {
                    burn = false;
                }
                
//                prev.x = current.x;
//                prev.y = current.y;
                
            } else {
                x = evt.pageX;
                y = evt.pageY;
            }
        }
    }
    
    function inputEnd(){
        if(current.x > -1){
            direction = 0;
            burn = false;
        }
        current.x = -1;
        start.x = -1;
        fire = false;
    }
    
    scaleCanvas();
    animate();
	</script>
</body>
</html>