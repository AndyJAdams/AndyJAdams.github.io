<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>STACKS</title>
	<style type="text/css">
		body{
            margin: 0;
            touch-action: none;
            position: fixed;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
        }
        canvas{
            touch-action: none;
            background-color: #323031;
        }
	</style>
</head>
<body id='body'>
<canvas></canvas>
    <script src="../Util/grid.js"></script>
	<script>
	var canvas = document.querySelector('canvas');
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	var ctx = canvas.getContext('2d');
    var selected = undefined;
    var selectionOffset = {x:0,y:0};
    var g = new Grid(3,3,130,145,innerWidth/2, innerHeight/2-100);
    var newTilePos = {x:innerWidth/2, y: innerHeight/2+200};
    var colors = ['#177E89','#61E786','#DB3A34','#FFC857'];
        
    var slots = [];
    function Slot(x,y){
        this.x = x; this.y = y;
        this.tiles = [];
        this.draw = function(){
            ctx.strokeStyle='#DDD';
            ctx.strokeRect(this.x-54,this.y-54,108,108);
        }
    }    
    
    var tiles= [];
    function Tile(x,y,v){
        this.x = x;this.y =y; this.v = v;
        this.tx = this.x; this.ty = this.y;
        
        this.draw = function(){
            ctx.fillStyle='#00000066';
            ctx.fillRect(this.tx-48,this.ty-48,96,100);
            ctx.fillStyle=colors[this.v];
            ctx.fillRect(this.tx-48,this.ty-48,96,96);
//            ctx.strokeStyle='#DDD';
//            ctx.strokeRect(this.tx-48,this.ty-48,96,96);
        }
        
        this.update = function(){
            this.draw();
        }
        
    }
        
    function buildGrid(){
        for(var i = 0; i < g.rows; i++){
            for(var j = 0; j < g.columns; j++){
                slots.push(new Slot(g.pos[i][j].x, g.pos[i][j].y));
            }
        }
        MakeNewTile();
    }
        
    function getTileColor(){
        return Math.floor(Math.random()*colors.length);
    }
        
    function MakeNewTile(){
        tiles.push(new Tile(newTilePos.x, newTilePos.y,getTileColor()));
    }

    //*************************************************
    //*************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);
        
        //g.draw(ctx);
        for(var i = 0; i< slots.length; i++){
            slots[i].draw();
        }
        
        for(var i = 0; i < tiles.length; i++){
            tiles[i].update();
        }
	}
    //*************************************************
    //*************************************************

    function getSelected(x,y){
        for(var i = 0; i < slots.length; i++){
            if(x < slots[i].x+54 && x >  slots[i].x-54 && y < slots[i].y+54 && y > slots[i].y-54){
                if(slots[i].tiles.length > 0){
                    return slots[i].tiles[slots[i].tiles.length-1];
                }
            }
        }
        for(var i = 0; i < tiles.length; i++){
            if(x < tiles[i].x+48 && x > tiles[i].x-48 && y < tiles[i].y+48 && y > tiles[i].y-48){
                return tiles[i];
            }
        }
        return undefined;
    }
        
	//*** INPUT SECTION **//
    window.addEventListener('keyup',function(e){
        console.log(e.keyCode);
    });
    
    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });


    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);

    var start = {x:-1,y:-1};
		var current = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
        }
        current.x = start.x;
        current.y = start.y;
        
        selected = getSelected(current.x, current.y);
        if(selected != undefined){
            selectionOffset.x = selected.x-current.x;
            selectionOffset.y = selected.y-current.y;
            console.log(selected);
        }
    }

    function inputMove(evt){
        evt.preventDefault();
        if(start.x > -1){
            if(evt.changedTouches != undefined){
                var touches = evt.changedTouches;
                if(touches.length > 0){
                    current.x = touches[0].pageX;
                    current.y = touches[0].pageY;
                }
            } else {
                current.x = evt.pageX;
                current.y = evt.pageY;
            }
            if(selected != undefined){
                selected.tx = current.x+selectionOffset.x;
                selected.ty = current.y+selectionOffset.y;
            }
        }
    }

    function inputEnd(){
        start.x = -1;
        if(selected != undefined){
            //Determine if the tile is over a slot
            for(var i = 0; i < slots.length; i++){
                if(selected.tx < slots[i].x+54 && selected.tx > slots[i].x-54 && selected.ty < slots[i].y+54 && selected.ty > slots[i].y-54){
                    if(slots[i].tiles.length < 3){
                        if(selected.x == newTilePos.x && selected.y == newTilePos.y){
                            MakeNewTile();
                        }
                        selected.x = slots[i].x;
                        selected.y = slots[i].y-(slots[i].tiles.length*10);
                        slots[i].tiles.push(selected);
                    } 
                    break;
                }
            }
            selected.tx = selected.x;
            selected.ty = selected.y;
        }
        selected = undefined;
    }

    scaleCanvas();
    buildGrid();
	animate();
	</script>
</body>
</html>
