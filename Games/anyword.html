<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>BLANK CANVAS</title>
	<style type="text/css">
	body{
					margin: 0;
					touch-action: none;
					position: fixed;
					-webkit-touch-callout: none !important;
					-webkit-user-select: none !important;
			}
			canvas{
					touch-action: none;
					background-color: #DDD;
			}
	</style>
	<script src='../Util/grid.js'></script>
</head>
<body id='body'>
<canvas></canvas>
	<script>
	var canvas = document.querySelector('canvas');
    function scaleCanvas(){
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
	}
	var ctx = canvas.getContext('2d');
	var alphabet = 'AAABBCCDDDEEEEFFFGGGHHIIIJKKLLLLMNNNNOOOPQRRRRSSSSTTTTUUUVWWXYYZ';
	var myTiles = [];


function Tile(r,c,l){
	this.r = r; this.c = c;
	this.l = l; this.highlight = false;
	this.x = grid.pos[this.r][this.c].x;
	this.y = grid.pos[this.r][this.c].y;
	this.size = 14;
	this.draw = function(){
		ctx.textAlign = 'center';
		ctx.textBaseline = 'middle';
		if(this.highlight){
			ctx.fillStyle='#FFF';
			ctx.font = 'bold 38px sans-serif';
		} else {
			ctx.fillStyle='#000';
			ctx.font = 'bold '+this.size+'px sans-serif';
		}
		ctx.fillText(this.l,this.x, this.y);
	}
}

	var grid = undefined;
	var tiles = [];
	function buildGrid(){
		grid = new Grid(12,10,innerHeight/20,innerHeight/20,innerWidth/2, innerHeight/2-80);
		for(var i = 0; i < 12; i++){
			var col = [];
			for(var j = 0; j < 10; j++){
				var letter = alphabet.charAt(Math.floor(Math.random()*alphabet.length));
				col.push(new Tile(i,j,letter));
			}
			tiles.push(col);
		}
	}

	var lastWord = {str:'',pos:'',phoe:'',def:''};
	var testString = '';
    //*************************************************
    //*************************************************
	function animate(){
		window.requestAnimationFrame(animate);
		ctx.clearRect(0,0,innerWidth,innerHeight);

		if(grid == undefined){
			buildGrid();
		}


		ctx.font = 'bold 44px sans-serif';
		ctx.textAlign = 'left';
		var myString = '';
		for(var i = 0; i < myTiles.length; i++){
			myString += myTiles[i].l;
			myTiles[i].highlight = true;
		}
		ctx.fillText(myString,tiles[0][0].x-5,tiles[0][0].y-40);

		//Draw filling line
		if(myTiles.length > 0){
				ctx.beginPath();
				ctx.arc(myTiles[0].x,myTiles[0].y,30,0,2*Math.PI);
				ctx.fillStyle='#000';
				ctx.fill();
				ctx.closePath();
				if(myTiles.length > 1){
					ctx.lineWidth = 60;
					ctx.lineCap = 'round';
					ctx.lineJoin = 'round';
					ctx.beginPath();
					ctx.moveTo(myTiles[0].x, myTiles[0].y);
					for(var i = 1; i < myTiles.length; i++){
						ctx.lineTo(myTiles[i].x, myTiles[i].y);
					}
					ctx.stroke();
					ctx.closePath();
				}
		}


		for(var i = 0; i < tiles.length; i++){
			for(var j=0; j < tiles[i].length; j++){
				tiles[i][j].draw();
			}
		}
		//grid.draw(ctx);

		if(request != undefined){
			ctx.fillText(request,10,10);
			var data = JSON.parse(request);
			if(data.length > 0){
				lastWord.str = testString;
				lastWord.def = data[0].meanings[0].definitions[0].definition;
				lastWord.phoe = data[0].phonetics[0].text;
				lastWord.pos = data[0].meanings[0].partOfSpeech;
			}
			for(var i = 0; i < myTiles.length; i++){
				myTiles[i].highlight = false;
			}
			myTiles = [];
			testString = '';
			request = undefined;
		}


		if(lastWord.str != ''){
			ctx.font = 'bold 44px sans-serif';
			ctx.textAlign = 'left';
			ctx.fillText(lastWord.str,tiles[0][0].x-5, tiles[11][0].y+65);
			ctx.font = 'italic 16px sans-serif';
			ctx.fillText(lastWord.pos + " (" + lastWord.phoe + ")",tiles[0][0].x, tiles[11][0].y+90);
			//Text wrap the definition (they get long sometimes)
			var limit = 65;
			var wraps = Math.floor(lastWord.def.length/limit);
			for(var i = 0;i <wraps; i++){
				ctx.font = '16px sans-serif';
				ctx.fillText(lastWord.def.slice(i*limit,(i+1)*limit),tiles[0][0].x, tiles[11][0].y+110+(i*20));
			}
			ctx.font = '16px sans-serif';
			ctx.fillText(lastWord.def.slice(wraps*limit),tiles[0][0].x, tiles[11][0].y+110+(wraps*20));
		}
	}
    //*************************************************
    //*************************************************

		var request = undefined;

		//DictionaryAPI
		function checkWord(str){
			var url = 'https://api.dictionaryapi.dev/api/v2/entries/en/'+str;
			fetch(url)
			.then(response => {
				console.log(response);
				return response.text();
			}).then(response =>{
					request = response;
			}).catch(error => {
					request = error;
			});
		}

		function getDistance(x1,y1,x2,y2){
			return Math.abs(Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2)));
		}

	//*** INPUT SECTION **//
    window.addEventListener('resize',function(evt){
        evt.preventDefault();
        scaleCanvas();
    });


    window.addEventListener('mousedown',inputStart,false);
    window.addEventListener('mousemove',inputMove,false);
    window.addEventListener('mouseup',inputEnd,false);

    window.addEventListener('touchstart',inputStart, false);
    window.addEventListener('touchmove', inputMove,false);
    window.addEventListener('touchcancel',inputEnd,false);
    window.addEventListener('touchend',inputEnd,false);

    var start = {x:-1,y:-1};
		var current = {x:-1,y:-1};
    function inputStart(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                start.x = touches[0].pageX;
                start.y = touches[0].pageY;
            }
        } else {
            start.x = evt.pageX;
            start.y = evt.pageY;
        }
				current.x = start.x;
				current.y = start.y;

				var r = grid.getCurrentRowFromPosition(start.x,start.y);
				var c = grid.getCurrentColFromPosition(current.x,current.y);
				myTiles.push(tiles[r][c]);
    }

    function inputMove(evt){
        evt.preventDefault();
        if(evt.changedTouches != undefined){
            var touches = evt.changedTouches;
            if(touches.length > 0){
                current.x = touches[0].pageX;
                current.y = touches[0].pageY;
            }
        } else {
            current.x = evt.pageX;
            current.y = evt.pageY;
        }



				if(tiles.length < 1){
					return;
				}
				for(var i = 0; i < tiles.length; i++){
					for(var j = 0; j < tiles[i].length; j++){
						var d  = getDistance(tiles[i][j].x, tiles[i][j].y,current.x,current.y);
						if(d > innerHeight/12){
							tiles[i][j].size = 14;
						} else {
							var offset = 1-d/(innerHeight/10);
							tiles[i][j].size = 14+(offset*30);
						}


					}
				}
				if(start.x > -1){
					//We're adding letters, let's go
					var r = grid.getCurrentRowFromPosition(current.x, current.y);
					var c = grid.getCurrentColFromPosition(current.x, current.y);
					if(tiles[r][c] != myTiles[myTiles.length-1]){
						if(myTiles.length > 1 && tiles[r][c] == myTiles[myTiles.length-2]){
							myTiles[myTiles.length-1].highlight = false;
							myTiles.pop();
						} else {
							myTiles.push(tiles[r][c]);
						}
					}
				}
    }

    function inputEnd(){
				if(myTiles.length > 1){
					for(var i = 0; i < myTiles.length; i++){
						testString += myTiles[i].l;
					}
					checkWord(testString);
				} else {
					myTiles[0].highlight = false;
					myTiles = [];
				}

        start.x = -1;
				//checkWord(testWord);
    }

    scaleCanvas();
	animate();
	</script>
</body>
</html>
