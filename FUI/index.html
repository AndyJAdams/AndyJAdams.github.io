<!DOCTYPE html>
<html>
<head>
<title>FUI</title>
<style>
    body{
        margin:0;
        touch-action: none;
        position: fixed;
        background-color: #eee;
        overflow: hidden;
        -webkit-touch-callout: none !important;
        -webkit-user-select: none !important;
    }
</style>
</head>
<body>
<canvas id='canvas'></canvas>
<script type='text/javascript'>
    
var version = 'D_0005';
var zoomSensitivity = 10;
var dragSensitivity = 50;

var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');

function scaleCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

var viewScale = 1;
ctx.fillStyle='#dedede';

function Base(x,y){
    this.x = x; this.y = y; 
    this.draw = function(){
        //ctx.fillStyle='#dedede';
        ctx.fillRect(this.x, this.y, 64,64);
    }
    
    this.update = function(){
        this.draw();
    }
}
    
var bases = [new Base(innerWidth/2-32,innerHeight/2-32)];

//////////////////////////////////////////////////////////////////////////////////////////////////////
function Update(){
    window.requestAnimationFrame(Update);
    ctx.clearRect(0,0,innerWidth,innerHeight);
    
    
    
    //Scaling
    if(viewScale < 0.1){
        viewScale = 0.1;
    } else if(viewScale > 4.0){
        viewScale = 4.0;
    }
    ctx.setTransform(viewScale,0,0,viewScale,0,0);
    var calcW = -(((innerWidth*viewScale)-innerWidth)/2)*(1/viewScale);
    var calcH = -(((innerHeight*viewScale)-innerHeight)/2)*(1/viewScale);
    ctx.translate(calcW,calcH);
    ctx.save();
    ctx.clearRect(-innerWidth*10,-innerHeight*10,innerWidth*20,innerHeight*20);
    ctx.restore();
    
    ctx.font = '24px sans-serif';
    for(var i = 0; i< ongoingTouches.length; i++){
        ctx.fillText(ongoingTouches[i].id + " @ "+Math.round(ongoingTouches[i].x) +","+ Math.round(ongoingTouches[i].y) + " from " + Math.round(ongoingTouches[i].px) + "," + Math.round(ongoingTouches[i].py),10,i*30+20);
    }
    
    ctx.fillText(version + " / " + ongoingTouches.length,10,innerHeight-20);
    
    
    for(var i = 0; i < bases.length;i++){
        bases[i].update();
    }
}
//////////////////////////////////////////////////////////////////////////////////////////////////////

function getDistance(x1, y1, x2, y2){
    return Math.sqrt(Math.pow(Math.abs(x1-x2),2)+Math.pow(Math.abs(y1-y2),2));
}    

/*INPUT SECTION*/
window.addEventListener('resize',function(evt){
   evt.preventDefault(); scaleCanvas(); 
});
window.addEventListener('wheel',function(evt){
    viewScale -= (evt.deltaY/1000);
    
});
//Keyboard/Mouse Inputs
var start = {x:-1,y:-1};
var current = {x:-1,y:-1};
    
window.addEventListener('mousedown',inputStart,false);
window.addEventListener('mousemove',inputMove,false);
window.addEventListener('mouseup',inputEnd,false);
    
function inputStart(evt){
    evt.preventDefault();
    start.x = evt.pageX;
    start.y = evt.pageY;
    current.x = start.x;
    current.y = start.y;
}

function inputMove(evt){
    evt.preventDefault();
    if(start.x > -1){
        current.x = evt.pageX;
        current.y = evt.pageY;
    }
}

function inputEnd(){
    start.x = -1;
}
    
//Touch inputs
window.addEventListener('touchstart', touchStart, false);
window.addEventListener('touchmove', touchMove,false);
window.addEventListener('touchcancel',touchEnd,false);
window.addEventListener('touchend',touchEnd,false);
var ongoingTouches = [];
    
function touchStart(evt){
    evt.preventDefault();
    var touches = evt.changedTouches;
    
    for(var i = 0; i < touches.length; i++){
        //ongoingTouches.push(copyTouch(touches[i]));
        ongoingTouches.push(new Touch(touches[i].identifier, touches[i].pageX, touches[i].pageY, touches[i].pageX,touches[i].pageY));
    }
}
    
function touchMove(evt){
    evt.preventDefault();
    var touches = evt.changedTouches;
    var dragging = false;
    
    for(var i = 0; i < touches.length; i++){
        var idx = ongoingTouchIndexById(touches[i].identifier);
        
        if(idx >= 0){
            //ongoingTouches.splice(idx,1,copyTouch(touches[i]));
            if(Math.abs(touches[i].pageX-ongoingTouches[idx].x) > dragSensitivity || Math.abs(touches[i].pageY-ongoingTouches[idx].y) > dragSensitivity){
                dragging = true;
            }
            ongoingTouches.splice(idx,1,new Touch(touches[i].identifier,touches[i].pageX,touches[i].pageY,ongoingTouches[idx].x,ongoingTouches[idx].y));
        }
    }
    
    if(dragging){
        if(ongoingTouches.length > 1){
            //We have two touches on screen is it a pinch/expand or a drag?
            //To determine if it is a zoom action we need to find the distance between the first two points
            var orgDist = getDistance(ongoingTouches[0].px,ongoingTouches[0].py,ongoingTouches[1].px, ongoingTouches[1].py);
            //Now we get the distance between the new points
            var newDist = getDistance(ongoingTouches[0].x,ongoingTouches[0].y, ongoingTouches[1].x,ongoingTouches[1].y);
            if(Math.abs(orgDist-newDist) > zoomSensitivity){ //A zooming action has occured
                if(newDist > orgDist){ //The points got further apart this is an expand or 'zoom-in' action
                    viewScale -= 0.1;
                    ctx.fillStyle='#0F0';
                } else if(orgDist > newDist){
                    viewScale += 0.1;
                    ctx.fillStyle='#F00';
                }
            } else {
                //A drag action has occured. We'll use the offsets from touch 0 to move the objects in play
            }
        } else if(ongoingTouches.length > 0){
            //Handle single input touches here
            
        }
    }
    
}
    
function touchEnd(evt){
    evt.preventDefault();
    var touches = evt.changedTouches;
    for(var i =0; i < touches.length; i++){
        var idx = ongoingTouchIndexById(touches[i].identifier);
        if(idx >= 0){
            ongoingTouches.splice(idx,1);
        }
    }
}
    
//function copyTouch({identifier,pageX,pageY,prevX,prevY}){
//    return {identifier,pageX,pageY,prevX,prevY};
//}
    
function ongoingTouchIndexById(idToFind){
    for(var i = 0; i < ongoingTouches.length; i++){
        var id = ongoingTouches[i].id;
        if(id == idToFind){
            return i;
        }
    }
    return -1;
}
    
function Touch(id,x,y,px,py){
    this.id = id; this.x = x; this.y = y; this.px = px; this.py = py;
}

scaleCanvas();    
Update();
</script>
</body>
</html>