<!DOCTYPE html><html><head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<style>
  body{ 
    margin:0; 
    font-size: 24pt;
    font-family: sans-serif;
    color: #CDC;
  }

  .triangle{
    width: 80px;
    height: 80px;
    background-color: #DDD;
    position: absolute;
  }
  .up{
    clip-path: polygon(50% 0, 0 100%, 100% 100%);
  }

  .down{
    clip-path: polygon(0 0, 100% 0, 50% 100%);
  }
</style>
<title>TRI ME</title></head>
<body id='body'>
  <!--<canvas id='canvas'></canvas>-->
  <h3 id='playerDisplay' style='text-align: center;'></h3>
  <div id='content'></div>
</body>
<script>
  $(document).ready(function(){
    window.setInterval(validate,200);
    var rows = 6;
    var tilesPerRow = 9;
    var playerCount = 4;
    var activePlayer = 0; 
    var playerColors = ['rgb(0, 0, 0)','rgb(0, 255, 0)','rgb(255, 0, 0)','rgb(0, 0, 255)'];
    var changeOccured = false;

    function scoreDisplay(){
      var display = $('#playerDisplay');
      for(var p = 0; p<playerCount; p++){
        display.append('<b class="score" id="score_'+p+'" style="color:'+playerColors[p]+';">0</b>&nbsp;&nbsp;&nbsp;');
      }
    }

    function makeGrid(){
      var scale = 80; //Set this equal to the value of width in the .triangle declaration of CSS
      var c = $('#content');
      var index = 0;
      var up = false;
      for(var r = 0; r < rows; r++){
        var TOP = (r*scale)+scale+(r*5);
        if(r%2==0){
          up = false;
        } else {
          up = true;
        }
        for(var t = 0; t < tilesPerRow; t++){
          var LEFT = ((t * (scale/2))+(t*5))+((window.innerWidth/2)-(tilesPerRow/3)*scale);
          if(!up){
            c.append("<div class='triangle down' id='"+index+"' row='"+r+"' style='top:"+TOP+"px; left:"+LEFT+"px;'></div>")
          } else {
            c.append("<div class='triangle up' id='"+index+"' row='"+r+"' style='top:"+TOP+"px; left:"+LEFT+"px;'></div>")
          }
          index++;
          up = !up;
        }
      }
    }    

    $(document.body).on('click','.triangle',function(){
      if($(this).attr('name') != 'blocked'){
        $(this).css('background-color', playerColors[activePlayer]);
        $(this).attr('name', 'blocked');
        var scoreText = $('#score_'+activePlayer);
        scoreText.css('text-decoration', '');
        //Swap to next player
        activePlayer++;
        if(activePlayer>playerCount-1){
          activePlayer=0;
        }
        //$('#playerDisplay').html('Player:'+(activePlayer+1));
        //$('#playerDisplay').css('color', playerColors[activePlayer]);
        $('#score_'+(activePlayer)).css('text-decoration', 'underline');

      } 
    });

    function validate(){
      for(var i = 0; i < tilesPerRow*rows;i++){
        var index = i;
        var tri = $('#'+(i));
        var row = parseInt(tri.attr('row'));
        var color = [];
        var changeOccured = false;
        if(index-1 > -1){
          var last = $('#'+(index-1));
          if(last.attr('row') == row && last.attr('name') == 'blocked'){
            color.push(last.css('background-color'));
          }
        }
        if(index+1 < tilesPerRow*rows){
          var next = $('#'+(index+1));
          if(next.attr('row')==row && next.attr('name') == 'blocked'){
            color.push(next.css('background-color'));
          }
        }
        var dir = tri.attr('class');
        if(dir =='triangle up'){
          if(index+tilesPerRow < tilesPerRow*rows){
            var third = $('#'+(index+tilesPerRow));
            if(third.attr('name')=='blocked'){
              color.push(third.css('background-color'));
            }
          }
        } else {
          if(index-tilesPerRow > -1){
            var third = $('#'+(index-tilesPerRow));
            if(third.attr('name')=='blocked'){
              color.push(third.css('background-color'));
            }
          }
        }
        //Loop through all colors and find matches
        for(var c = 0; c < color.length; c++){
          for(var n = 0; n < color.length; n++){
            if(n != c && color[n] == color[c]){
              tri.css('background-color',color[c]);
              tri.attr('name','blocked');
              changeOccured = true;
            }
          } 
        }
      }
      checkWinner();
    }

    function checkWinner(){
      var count = 0;
      var points = [];
      for(var p =0; p < playerCount; p++){
        points.push(0);
      }
      for(var i = 0; i < tilesPerRow*rows; i++){
        var tile = $('#'+i);
        if(tile.attr('name')!='blocked'){
          count++;
        } else {
          for(var c = 0; c < playerColors.length; c++){
            if(tile.attr('name')=='blocked'){
              
              if(tile.css('background-color')==playerColors[c]){
                points[c]++;
              }
            }
          }
        }
      }
      for(var o = 0; o < points.length; o++){
        $('#score_'+o).html(points[o]);
      }
      if(count == 0){
        //Somebody won...
        console.log('winner');
      }
    }
    
    
    makeGrid();
    scoreDisplay();
  });


</script>
</html>