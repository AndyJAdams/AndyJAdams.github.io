<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TEST</title>
	<style type="text/css">
		body{ 
			margin: 0; 
            background-color: #222;
		}
		canvas{
			border: 0px solid black;
		}
	</style>
</head>
<body>
	<canvas></canvas>
    <!--Cool stuff -->
	<script>
		var canvas = document.querySelector('canvas');
        scaleCanvas();
        function scaleCanvas(){
    	   canvas.width = window.innerWidth-3;
	   	   canvas.height = window.innerHeight-3;
        }
		var ctx = canvas.getContext('2d');
        ctx.font = '12px sans-serif';
        var debugMode = false;
        
        function Tile(x,y,w,h, colour){
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.color = colour;
            this.nx = x;
            this.ny = y;
            this.immobile = false;
            this.draw= function(){
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                if(debugMode){
                    ctx.fillStyle='#000';
                    ctx.fillText(this.x + "," + this.y + " " + this.color, this.x+5, this.y+20);
                }

                if(this.immobile){
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.moveTo(this.x+10,this.y+10);
                    ctx.lineTo(this.x+this.w-10,this.y+this.h-10);
                    ctx.moveTo(this.x+this.w-10,this.y+10);
                    ctx.lineTo(this.x+10,this.y+this.h-10);
                    ctx.stroke();
                    ctx.closePath();
                }
            }
            
            this.update = function(){
                this.draw();
            }
        }
        
        var columns = 10;
        var rows = 8;
        var tileWidth = 0; var tileHeight = 0;
        var Tiles = undefined;
        var ca = ["#9BB25B", "#8E4979", "#F19E3E", "#33609E","#F06058","#d2dae2","#1e272e","#0fbcf9","#05c46b","#808e9b"];
        function genGrid(){
            tileWidth = Math.floor(innerWidth/columns);
            tileHeight = Math.floor(innerHeight/rows);
            Tiles=[];
            
            for(var r = 0; r < rows; r++){
                Tiles[r] = [];
                for(var c = 0; c < columns; c++){
                    //var ncolor = ca[Math.floor(Math.random()*ca.length)];
                    var ncolor = ca[c];
                    Tiles[r][c] = new Tile(c*tileWidth+1, r*tileHeight+1, tileWidth-2, tileHeight-2, ncolor);
                    if(r == rows/2 && c == columns/2){
                        Tiles[r][c].immobile = true;
                    }
                }
            }
        }

        function scaleGrid(){
            tileWidth = Math.floor(innerWidth/columns);
            tileHeight = Math.floor(innerHeight/rows);
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    Tiles[i][j].x = j*tileWidth+1;
                    Tiles[i][j].y = i*tileHeight+1;
                    Tiles[i][j].w = tileWidth-2;
                    Tiles[i][j].h = tileHeight-2;
                }
            }
        }
		function animate(){
			requestAnimationFrame(animate);
			ctx.clearRect(0,0,innerWidth, innerHeight);
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    Tiles[i][j].update();
                }
            }
		}

        function scramble(){
            var rand = Math.floor(Math.random() * (rows*columns));
            for(var i = 0; i < rand; i++){
                //Select first random tile
                var a = Tiles[Math.floor(Math.random()*rows)][Math.floor(Math.random()*columns)];
                var b = Tiles[Math.floor(Math.random()*rows)][Math.floor(Math.random()*columns)];
                if(a != b && !a.immobile && !b.immobile){
                    var c = a.color;
                    a.color = b.color;
                    b.color = c;
                } else {
                    i--;
                }
            }
        }
        
        var cx, cy, drag = false, lock = undefined;
        var smp = {
            x: undefined,
            y: undefined
        }
        var offset = {
            x: undefined,
            y: undefined
        }
        var affected = [];
        
        //TOUCH INPUT SECTION
//		canvas.addEventListener('touchmove', function(e){
//			ctx.fillRect(e.touches[0].clientX-10, e.touches[0].clientY-10, 20, 20);
//			ctx.fill();
//			output.innerHTML = (e.touches[0].clientX + ","+e.touches[0].clientY + " x " + e.touches[0].force);
//			e.preventDefault();
//		},false);
        
        //MOUSE INPUT SECTION
        
        canvas.addEventListener('mousedown', function(event){
			//Do the down
            cx = Math.floor(event.x/tileWidth) * tileWidth;
            cy = Math.floor(event.y/tileHeight) * tileHeight;
            smp.x = event.x; smp.y = event.y;
            offset.x = smp.x - cx; offset.y = smp.y - cy;
            drag = true;
		},false);
        
		canvas.addEventListener('mousemove', function(event){
            if(drag){
			 //Wait for player to pick H or V
                var cmp = {
                    x: event.x,
                    y: event.y
                }
                if(Math.abs(smp.x-cmp.x) > 10 || Math.abs(smp.y-cmp.y) > 10){
                    //Actually moving here.  
                    if(lock == undefined){
                        if(Math.abs(smp.x-cmp.x) > Math.abs(smp.y-cmp.y)){
                            //Horiztonal
                            affected = GetRow(cy);
                            lock = 'x';
                        } else {
                            //Vertical
                            affected = GetColumn(cx);
                            lock = 'y';
                        }
                    }
                }
                /*
                if(lock=='x'){ //Horizontal
                    if(Math.abs(cmp.x-smp.x)>10){ //Drag is taking place
                        var dragx = cmp.x-smp.x;
                        for(var i = 0; i < affected.length; i++){
                            affected[i].x = affected[i].nx + dragx;
                            if(affected[i].x > ((columns)*tileWidth)+3){
                                affected[i].nx = 2;
                            } else if(affected[i].x < 0){
                                affected[i].nx = (columns-1)*tileWidth+2;
                            }
                        }
                    }
                }
                */
                
                if(lock == 'x'){
                    //Horz
                    //console.log(affected.length+" h/ " + cy);
                    for(var q = 0; q < affected.length; q++){
                        if(affected[q].immobile){
                            return;
                        }
                    }
                    var ncx = Math.floor(event.x/tileWidth) * tileWidth;
                    if(Math.abs(cx-ncx) > 10){
                        for(var i = 0; i < affected.length; i++){
                            var shift = (cx-ncx);
                            affected[i].x -= shift;
                            if(affected[i].x < 0){
                                affected[i].x = (columns-1)*tileWidth+1;
                            } else if(affected[i].x > ((columns-1)*tileWidth)+5){
                                affected[i].x = 1;
                            }
                        }
                        cx = ncx;
                    }
                } else if(lock == 'y'){
                    //Vert
                    for(var q = 0; q < affected.length; q++){
                        if(affected[q].immobile){
                            return;
                        }
                    }
                    var ncy = Math.floor(event.y/tileHeight) * tileHeight;
                    if(Math.abs(cy-ncy) > 10){
                        for(var i = 0; i < affected.length; i++){
                            affected[i].y -= (cy-ncy);
                            if(affected[i].y < 0){
                                affected[i].y = ((rows-1)*tileHeight+1);
                            } else if(affected[i].y > ((rows-1)*tileHeight)+5){
                                affected[i].y = 1;
                            }
                        } 
                        cy = ncy;
                    }
                    
                }
            }
		},false);
        
        canvas.addEventListener('mouseup', function(event){
			//Do the up
            drag = false;
            lock = undefined;
            affected.empty;
            scanGrid();
		},false);
        
        canvas.addEventListener('mouseout', function(event){
           drag = false;
            lock = undefined;
            affected.empty;
        });

        function scanGrid(){

        }
        
        function GetColumn(col){
            var retTiles = [];
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    if(Math.abs(Tiles[i][j].x-col) < 10){
                        retTiles.push(Tiles[i][j]);
                    }
                }
            }
            return retTiles;
        }
        
        
        window.addEventListener('keydown', function(event){
           if(event.keyCode == 68){
               debugMode = !debugMode;
           } 
        });
        window.addEventListener('keydown', function(event){
           if(event.keyCode == 83){
            for(var i = 0; i < 4; i++){
               scramble();
            }
           } 
        });

        window.addEventListener('resize',function(){
            scaleCanvas();
            scaleGrid();
        });
        
        function GetRow(row){
            var retTiles = [];
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    if(Math.abs(Tiles[i][j].y-row) < 10){
                        retTiles.push(Tiles[i][j]);
                    }
                }
            }
            return retTiles;
        }
        genGrid();
		animate();
	</script>
</body>
</html>