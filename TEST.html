<DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TEST</title>
	<style type="text/css">
		body{ 
			margin: 0; 
            background-color: #222;
		}
		canvas{
			border: 0px solid black;
		}
	</style>
</head>
<body>
	<canvas></canvas>
    <!--Cool stuff -->
	<script>
		var canvas = document.querySelector('canvas');
		canvas.width = window.innerWidth-3;
		canvas.height = window.innerHeight-3;
		var ctx = canvas.getContext('2d');
        ctx.font = '12px sans-serif';
        var debugMode = false;
        
        function Tile(x,y,w,h, colour){
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.color = colour;
            
            this.draw= function(){
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.w, this.h);
                if(debugMode){
                    ctx.fillStyle='#000';
                    ctx.fillText(this.x + "," + this.y + " " + this.color, this.x+5, this.y+20);
                }
            }
            
            this.update = function(){
                this.draw();
            }
        }
        
        var columns = 5;
        var rows = 5;
        var tileWidth = Math.floor(innerWidth/columns);
        var tileHeight = Math.floor(innerHeight/rows);
        var Tiles=[];
        var ca = ["#9BB25B", "#8E4979", "#F19E3E", "#33609E","#F06058"];
        for(var r = 0; r < rows; r++){
            Tiles[r] = [];
            for(var c = 0; c < columns; c++){
                var ncolor = ca[Math.floor(Math.random()*ca.length)];
                //var ncolor = ca[c];
                Tiles[r][c] = new Tile(c*tileWidth+2, r*tileHeight+2, tileWidth-4, tileHeight-4, ncolor);
            }
        }

		function animate(){
			requestAnimationFrame(animate);
			ctx.clearRect(0,0,innerWidth, innerHeight);
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    Tiles[i][j].update();
                }
            }
		}

//		canvas.addEventListener('touchmove', function(e){
//			ctx.fillRect(e.touches[0].clientX-10, e.touches[0].clientY-10, 20, 20);
//			ctx.fill();
//			output.innerHTML = (e.touches[0].clientX + ","+e.touches[0].clientY + " x " + e.touches[0].force);
//			e.preventDefault();
//		},false);
        var cx, cy, drag = false, lock = undefined;
        var smp = {
            x: undefined,
            y: undefined
        }
        var affected = [];
        canvas.addEventListener('mousedown', function(event){
			//Do the down
            cx = Math.floor(event.x/tileWidth) * tileWidth;
            cy = Math.floor(event.y/tileHeight) * tileHeight;
            smp.x = event.x; smp.y = event.y;
            drag = true;
		},false);
        
		canvas.addEventListener('mousemove', function(event){
            if(drag){
			 //Wait for player to pick H or V
                var cmp = {
                    x: event.x,
                    y: event.y
                }
                if(Math.abs(smp.x-cmp.x) > 10 || Math.abs(smp.y-cmp.y) > 10){
                    //Actually moving here.  
                    if(lock == undefined){
                        if(Math.abs(smp.x-cmp.x) > Math.abs(smp.y-cmp.y)){
                            //Horiztonal
                            affected = GetRow(cy);
                            lock = 'x';
                        } else {
                            //Vertical
                            affected = GetColumn(cx);
                            lock = 'y';
                        }
                    }
                }
                
                if(lock == 'x'){
                    //Horz
                    //console.log(affected.length+" h/ " + cy);
                    var ncx = Math.floor(event.x/tileWidth) * tileWidth;
                    if(Math.abs(cx-ncx) > 10){
                        for(var i = 0; i < affected.length; i++){
                            var shift = (cx-ncx);
                            affected[i].x -= shift;
                            if(affected[i].x < 0){
                                affected[i].x = (columns-1)*tileWidth+2;
                            } else if(affected[i].x > ((columns-1)*tileWidth)+5){
                                affected[i].x = 2;
                            }
                        }
                        cx = ncx;
                    }
                } else if(lock == 'y'){
                    //Vert
                    var ncy = Math.floor(event.y/tileHeight) * tileHeight;
                    if(Math.abs(cy-ncy) > 10){
                        for(var i = 0; i < affected.length; i++){
                            affected[i].y -= (cy-ncy);
                            if(affected[i].y < 0){
                                affected[i].y = ((rows-1)*tileHeight+2);
                            } else if(affected[i].y > ((rows-1)*tileHeight)+5){
                                affected[i].y = 2;
                            }
                        } 
                        cy = ncy;
                    }
                    
                }
            }
		},false);
        
        canvas.addEventListener('mouseup', function(event){
			//Do the up
            drag = false;
            lock = undefined;
            affected.empty;
            
		},false);
        
        function GetColumn(col){
            var retTiles = [];
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    if(Math.abs(Tiles[i][j].x-col) < 10){
                        retTiles.push(Tiles[i][j]);
                    }
                }
            }
            return retTiles;
        }
        
        window.addEventListener('keydown', function(event){
           if(event.keyCode == 68){
               debugMode = !debugMode;
           } 
        });
        
        function GetRow(row){
            var retTiles = [];
            for(var i = 0; i < rows; i++){
                for(var j = 0; j < columns; j++){
                    if(Math.abs(Tiles[i][j].y-row) < 10){
                        retTiles.push(Tiles[i][j]);
                    }
                }
            }
            return retTiles;
        }

		animate();
	</script>
</body>
</html>